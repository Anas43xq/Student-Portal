name: Create Feature Branch PR

on:
  push:
    branches:
      - feature/**
      - chore/**
      - fix/**
  workflow_dispatch:
    inputs:
      head_branch:
        description: 'Branch to create PR from'
        required: true
        default: 'feature/new-feature'
      base_branch:
        description: 'Target branch for PR'
        required: true
        default: 'main'
      pr_title:
        description: 'PR title'
        required: true
      pr_body:
        description: 'PR description'
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  create_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get branch info from workflow trigger
            let head, base, title, body;

            if (context.eventName === 'workflow_dispatch') {
              head = context.payload.inputs.head_branch;
              base = context.payload.inputs.base_branch;
              title = context.payload.inputs.pr_title;
              body = context.payload.inputs.pr_body || 'Auto-generated PR from workflow dispatch';
            } else {
              // For push events, extract branch info
              head = context.payload.ref.replace('refs/heads/', '');
              base = 'main';

              // Generate title from branch name
              const branchName = head.split('/').pop().replace(/-/g, ' ');
              title = `${head.split('/')[0]}: ${branchName.charAt(0).toUpperCase() + branchName.slice(1)}`;

              // Generate description
              body = `This PR implements changes for the ${head} branch.\n\nPlease review and merge when ready.`;
            }

            try {
              // Check if an open PR already exists for this head -> base
              const { data: prs } = await github.rest.pulls.list({
                owner,
                repo,
                head: `${owner}:${head}`,
                base,
                state: 'open'
              });

              if (prs && prs.length > 0) {
                console.log('PR already exists:', prs[0].html_url);
                return;
              }

              // Create the PR
              const { data } = await github.rest.pulls.create({
                owner,
                repo,
                head,
                base,
                title,
                body
              });

              console.log('Created PR:', data.html_url);

              // Add a comment to the PR
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: data.number,
                body: 'ðŸ¤– This PR was auto-generated by the Create Feature Branch PR workflow.'
              });

            } catch (error) {
              console.error('Error creating PR:', error);
              throw error;
            }
